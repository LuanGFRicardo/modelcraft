{% extends "base.html" %} {% block title %}Editar Peça{% endblock %} {% block
content %}
<div class="container my-5">
  <div
    class="d-flex justify-content-between align-items-center mb-4 page-header"
  >
    <h1 class="display-6 m-0">Editar Peça</h1>
    <a href="{{ url_for('auth.listagem') }}" class="btn btn-soft-danger">
      <span class="btn-icon" aria-hidden="true">
        <svg
          viewBox="0 0 24 24"
          width="18"
          height="18"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            d="M15 18l-6-6 6-6"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </span>
      <span class="ms-1">Voltar</span>
    </a>
  </div>

  <div class="card shadow-sm card-elevate form-card mb-4">
    <div class="card-body">
      <form
        id="formPeca"
        action="{{ url_for('auth.atualizar_peca', id=peca.id) }}"
        method="POST"
        enctype="multipart/form-data"
      >
        <!-- ===== Arquivo ===== -->
        <fieldset class="fieldset mb-4">
          <legend class="section-title">Arquivo</legend>

          <div class="mb-3">
            <label class="form-label fw-semibold"
              >Substituir arquivo (opcional)</label
            >
            <input
              class="form-control"
              type="file"
              id="meshFile"
              name="meshFile"
              accept=".json,application/json"
            />
            {% if peca.arquivo_json %}
            <div class="form-text input-hint">
              Arquivo atual: {{ peca.arquivo_json }}
            </div>
            {% endif %}
          </div>
        </fieldset>

        <!-- ===== Dados básicos ===== -->
        <fieldset class="fieldset mb-4">
          <legend class="section-title">Informações básicas</legend>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Nome da Peça</label>
              <input
                type="text"
                class="form-control"
                name="nome"
                id="nome"
                value="{{ peca.nome }}"
                required
              />
              <small class="input-hint"
                >Como a peça aparece nas listagens.</small
              >
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Material</label>
              <input
                type="text"
                class="form-control"
                name="material"
                id="material"
                value="{{ peca.material or '' }}"
              />
            </div>
          </div>
        </fieldset>

        <!-- ===== Dimensões ===== -->
        <fieldset class="fieldset mb-4">
          <legend class="section-title">Dimensões (mm)</legend>

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label fw-semibold">Comprimento (mm)</label>
              <input
                type="number"
                step="0.001"
                class="form-control"
                name="comprimento_mm"
                id="width"
                value="{{ peca.comprimento_mm }}"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label fw-semibold">Largura (mm)</label>
              <input
                type="number"
                step="0.001"
                class="form-control"
                name="largura_mm"
                id="depth"
                value="{{ peca.largura_mm }}"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label fw-semibold">Altura (mm)</label>
              <input
                type="number"
                step="0.001"
                class="form-control"
                name="altura_mm"
                id="height"
                value="{{ peca.altura_mm }}"
              />
            </div>
          </div>

          <div class="mt-3">
            <button type="button" id="btnCalcular" class="btn btn-soft-primary">
              <span class="btn-icon" aria-hidden="true">
                <svg
                  viewBox="0 0 24 24"
                  width="18"
                  height="18"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M21 3H3v18h18V3zM7 7h10M7 12h10M7 17h4"
                    stroke-linecap="round"
                  />
                </svg>
              </span>
              <span class="ms-1">Calcular Dimensões</span>
            </button>
            <small class="input-hint ms-2"
              >Usa o JSON carregado para preencher as medidas.</small
            >
          </div>
        </fieldset>

        <!-- ===== Comercial ===== -->
        <fieldset class="fieldset">
          <legend class="section-title">Comercial</legend>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Peso (kg)</label>
              <input
                type="number"
                step="0.001"
                class="form-control"
                name="peso_kg"
                id="peso_kg"
                value="{{ peca.peso_kg }}"
              />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Preço (R$)</label>
              <input
                type="number"
                step="0.01"
                class="form-control"
                name="preco"
                id="preco"
                value="{{ peca.preco }}"
              />
            </div>
          </div>
        </fieldset>

        <div class="form-actions d-flex justify-content-end gap-2 mt-4">
          <a href="{{ url_for('auth.listagem') }}" class="btn btn-soft-danger"
            >Cancelar</a
          >
          <button type="submit" class="btn btn-primary btn-elevate">
            <span class="btn-icon" aria-hidden="true">
              <svg
                viewBox="0 0 24 24"
                width="18"
                height="18"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M20 7v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7" />
                <path d="M3 7h18" />
                <path d="M8 7V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
              </svg>
            </span>
            <span class="ms-1">Salvar Alterações</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Mesmo script de cálculo da criação (mantém funcionalidade) -->
<script>
  document.getElementById("btnCalcular").addEventListener("click", async () => {
    const fileInput = document.getElementById("meshFile");
    const file = fileInput.files?.[0];
    if (!file) return alert("Selecione um arquivo JSON primeiro.");

    const text = await file.text();
    const json = JSON.parse(text);
    let Xmin = Infinity,
      Ymin = Infinity,
      Zmin = Infinity;
    let Xmax = -Infinity,
      Ymax = -Infinity,
      Zmax = -Infinity;
    const buffer = [];

    function* walkNumbers(node) {
      if (node == null) return;
      if (typeof node === "number") yield node;
      else if (Array.isArray(node)) for (const n of node) yield* walkNumbers(n);
      else if (typeof node === "object")
        for (const k in node) yield* walkNumbers(node[k]);
    }

    for (const num of walkNumbers(json.objects)) {
      const val = Number(num);
      if (!Number.isFinite(val)) continue;
      buffer.push(val);
      if (buffer.length === 3) {
        const [x, y, z] = buffer;
        Xmin = Math.min(Xmin, x);
        Xmax = Math.max(Xmax, x);
        Ymin = Math.min(Ymin, y);
        Ymax = Math.max(Ymax, y);
        Zmin = Math.min(Zmin, z);
        Zmax = Math.max(Zmax, z);
        buffer.length = 0;
      }
    }

    const width = Xmax - Xmin;
    const depth = Ymax - Ymin;
    const height = Zmax - Zmin;

    document.getElementById("width").value = width.toFixed(3);
    document.getElementById("depth").value = depth.toFixed(3);
    document.getElementById("height").value = height.toFixed(3);

    const volume = width * depth * height;
    document.getElementById("peso_kg").value = (volume / 1000000).toFixed(3);
  });

  (function () {
    const input = document.getElementById('meshFile');
    const btn   = document.getElementById('btnCalcular');
    if (!input || !btn) return;

    input.addEventListener('change', () => {
      if (input.files && input.files.length) {
        btn.click();
      }
    });
  })();
</script>
{% endblock %}
